<!DOCTYPE HTML><html><head><meta charset=UTF-8><meta content="text/html; charset=utf-8" http-equiv=Content-Type><title>3.5 处理多次调用及可选参数 · GitBook</title><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=description content=""><meta name=generator content="GitBook 3.2.3"><link rel=stylesheet href=../gitbook/style.css><link rel=stylesheet href=../gitbook/gitbook-plugin-highlight/website.css><link rel=stylesheet href=../gitbook/gitbook-plugin-search/search.css><link rel=stylesheet href=../gitbook/gitbook-plugin-fontsettings/website.css><meta name=HandheldFriendly content=true><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=black><link rel=apple-touch-icon-precomposed sizes=152x152 href=../gitbook/images/apple-touch-icon-precomposed-152.png><link rel="shortcut icon" href=../gitbook/images/favicon.ico type=image/x-icon><link rel=next href=其它功能的实现.html><link rel=prev href=链式调用.html></head><body><div class=book><div class=book-summary><div id=book-search-input role=search><input type=text placeholder="Type to search"></div><nav role=navigation><ul class=summary><li class=chapter data-level=1.1 data-path=../ ><a href=../ >Introduction</a></li><li class=chapter data-level=1.2><span>第1章 前期准备</span><ul class=articles><li class=chapter data-level=1.2.1 data-path=../chapter1/实例对象与函数对象.html><a href=../chapter1/实例对象与函数对象.html>1.1 实例对象与函数对象</a></li><li class=chapter data-level=1.2.2 data-path=../chapter1/回调函数的种类.html><a href=../chapter1/回调函数的种类.html>1.2 回调函数的种类</a></li><li class=chapter data-level=1.2.3 data-path=../chapter1/js中的Error.html><a href=../chapter1/js中的Error.html>1.3 js中的Error</a></li></ul></li><li class=chapter data-level=1.3 data-path=../chapter2/ ><a href=../chapter2/ >Promise理解和使用</a><ul class=articles><li class=chapter data-level=1.3.1 data-path=../chapter2/Promise是什么.html><a href=../chapter2/Promise是什么.html>2.1 Promise是什么</a></li><li class=chapter data-level=1.3.2 data-path=../chapter2/为何要用Promise.html><a href=../chapter2/为何要用Promise.html>2.2 为何要用Promise</a></li><li class=chapter data-level=1.3.3 data-path=../chapter2/如何使用Promise.html><a href=../chapter2/如何使用Promise.html>2.3 如何使用Promise</a></li></ul></li><li class=chapter data-level=1.4><span>第3章 手写Promise</span><ul class=articles><li class=chapter data-level=1.4.1 data-path=初步实现.html><a href=初步实现.html>3.1 初步实现</a></li><li class=chapter data-level=1.4.2 data-path=处理异常.html><a href=处理异常.html>3.3 处理异常</a></li><li class=chapter data-level=1.4.3 data-path=处理多回调及异步.html><a href=处理多回调及异步.html>3.3 处理多回调及异步</a></li><li class=chapter data-level=1.4.4 data-path=链式调用.html><a href=链式调用.html>3.4 链式调用</a></li><li class="chapter active" data-level=1.4.5 data-path=处理多次调用及可选参数.html><a href=处理多次调用及可选参数.html>3.5 处理多次调用及可选参数</a></li><li class=chapter data-level=1.4.6 data-path=其它功能的实现.html><a href=其它功能的实现.html>3.5 其它功能的实现</a></li></ul></li><li class=divider></li><li><a href=https://www.gitbook.com target=blank class=gitbook-link>Published with GitBook</a></li></ul></nav></div><div class=book-body><div class=body-inner><div class=book-header role=navigation><h1><i class="fa fa-circle-o-notch fa-spin"></i><a href=..>3.5 处理多次调用及可选参数</a></h1></div><div class=page-wrapper tabindex=-1 role=main><div class=page-inner><div id=book-search-results><div class=search-noresults><section class="normal markdown-section"><h1 id=&#x5904;&#x7406;&#x591A;&#x6B21;&#x8C03;&#x7528;>&#x5904;&#x7406;&#x591A;&#x6B21;&#x8C03;&#x7528;</h1><p>PromiseA+&#x89C4;&#x8303;&#x4E2D;&#x89C4;&#x5B9A;&#xFF1A;resolve&#x6216;reject&#x65B9;&#x6CD5;&#x53EA;&#x80FD;&#x8C03;&#x7528;&#x4E00;&#x6B21;&#xFF0C;&#x5982;&#x679C;&#x88AB;&#x8C03;&#x7528;&#x591A;&#x6B21;&#xFF0C;&#x5219;&#x53EA;&#x5904;&#x7406;&#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x7528;&#xFF0C;&#x5176;&#x4F59;&#x7684;&#x90FD;&#x4F1A;&#x88AB;&#x5FFD;&#x7565;&#x3002;</p><p>&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x7684;Promise&#x5E93;&#x662F;&#x7B26;&#x5408;&#x8FD9;&#x4E00;&#x89C4;&#x8303;&#x7684;&#xFF0C;&#x4F46;&#x522B;&#x4EBA;&#x7684;Promise&#x5E93;&#x4E0D;&#x4E00;&#x5B9A;&#x7B26;&#x5408;&#x6B64;&#x89C4;&#x8303;&#xFF0C;&#x4E0B;&#x9762;&#x5904;&#x7406;&#x8FD9;&#x4E00;&#x95EE;&#x9898;</p><p>&#x6211;&#x4EEC;&#x7684;then&#x65B9;&#x6CD5;&#x4E2D;&#x5224;&#x65AD;&#x4E86;&#x5F53;&#x524D;Promise&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x53EA;&#x8981;&#x8C03;&#x7528;&#x4E00;&#x6B21;resolve&#x6216;reject&#xFF0C;Promise&#x7684;&#x72B6;&#x6001;&#x5C31;&#x4F1A;&#x53D1;&#x751F;&#x53D8;&#x5316;&#xFF0C;&#x6240;&#x4EE5;&#x540E;&#x9762;&#x591A;&#x6B21;&#x7684;&#x8C03;&#x7528;&#x90FD;&#x662F;&#x65E0;&#x6548;&#x7684;&#x3002;</p><p>&#x5047;&#x8BBE;&#x522B;&#x4EBA;&#x7684;Promise&#x5E93;&#x53EB;&#x505A;OtherPromise&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#xFF1A;</p><pre><code class=lang-js><span class=hljs-keyword>const</span> <span class=hljs-built_in>Promise</span> = <span class=hljs-built_in>require</span>(<span class=hljs-string>&apos;./promise&apos;</span>)
<span class=hljs-keyword>const</span> OtherPromise = <span class=hljs-built_in>require</span>(<span class=hljs-string>&apos;otherpromise&apos;</span>)
<span class=hljs-keyword>const</span> promise = <span class=hljs-keyword>new</span> <span class=hljs-built_in>Promise</span>((resolve, reject) =&gt; {
  resolve(<span class=hljs-string>&apos;&#x6210;&#x529F;&#x4E86;&apos;</span>)
})

<span class=hljs-keyword>let</span> promise2 = promise.then(value =&gt; {
  <span class=hljs-keyword>return</span> <span class=hljs-keyword>new</span> OtherPromise((resolve, reject) =&gt; {
    resolve(<span class=hljs-string>&apos;&#x522B;&#x4EBA;Promise&#x5E93;resolve&#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x7528;&apos;</span>)
    resolve(<span class=hljs-string>&apos;&#x522B;&#x4EBA;Promise&#x5E93;resolve&#x7B2C;&#x4E8C;&#x6B21;&#x8C03;&#x7528;&apos;</span>)
  })
})

promise2.then(value =&gt; {
  <span class=hljs-built_in>console</span>.log(<span class=hljs-string>&apos;value2&apos;</span>, value) <span class=hljs-comment>// &#x8FD9;&#x91CC;&#x5C31;&#x6709;&#x53EF;&#x80FD;&#x8F93;&#x51FA;&#x4E24;&#x6B21;&#xFF0C;&#x4E0D;&#x7B26;&#x5408;&#x89C4;&#x8303;</span>
})
</code></pre><p>&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;Boolean&#x53D8;&#x91CF;called&#xFF0C;&#x7528;&#x6765;&#x6807;&#x8BB0;resolve&#x6216;&#x8005;reject&#x662F;&#x5426;&#x88AB;&#x8C03;&#x7528;&#x8FC7;&#xFF0C;&#x521D;&#x59CB;&#x503C;&#x4E3A;false&#xFF0C;&#x53EA;&#x8981;&#x8C03;&#x7528;&#x8FC7;&#x4E00;&#x6B21;&#xFF0C;&#x5C31;&#x5C06;called&#x7F6E;&#x4E3A;true&#xFF0C;&#x8C03;&#x7528;resolve&#x6216;reject&#x4E4B;&#x524D;&#x9700;&#x8981;&#x5224;&#x65AD;called&#x662F;&#x5426;&#x4E3A;true&#xFF0C;&#x82E5;&#x4E3A;false&#x5219;&#x8C03;&#x7528;&#xFF0C;&#x53CD;&#x4E4B;&#x65E0;&#x89C6;</p><pre><code class=lang-js><span class=hljs-keyword>const</span> resolvePromise = (promise2, x, resolve, reject) =&gt; {
  <span class=hljs-keyword>if</span> (x === promise2) {
    <span class=hljs-keyword>return</span> reject(<span class=hljs-keyword>new</span> <span class=hljs-built_in>TypeError</span>(<span class=hljs-string>&apos;Chaining cycle detected for promise #&lt;Promise&gt;&lt;/Promise&gt;&apos;</span>))
  }

  <span class=hljs-keyword>let</span> called = <span class=hljs-literal>false</span>
  <span class=hljs-keyword>if</span> ((<span class=hljs-keyword>typeof</span> x === <span class=hljs-string>&apos;object&apos;</span> &amp;&amp; x !== <span class=hljs-literal>null</span>) || <span class=hljs-keyword>typeof</span> x === <span class=hljs-string>&apos;function&apos;</span>) {
    <span class=hljs-keyword>try</span> {
      <span class=hljs-keyword>const</span> then = x.then
      <span class=hljs-keyword>if</span> (<span class=hljs-keyword>typeof</span> then === <span class=hljs-string>&apos;function&apos;</span>) {
        then.call(x, y =&gt; {
          <span class=hljs-keyword>if</span> (called) {
            <span class=hljs-keyword>return</span>
          }
          called = <span class=hljs-literal>true</span>
          resolvePromise(promise2, y, resolve, reject)
        }, r =&gt; {
          <span class=hljs-keyword>if</span> (called) {
            <span class=hljs-keyword>return</span>
          }
          called = <span class=hljs-literal>true</span>
          reject(r)
        })
      } <span class=hljs-keyword>else</span> {
        resolve(x)
      }
    } <span class=hljs-keyword>catch</span> (e) {
      <span class=hljs-keyword>if</span> (called) {
        <span class=hljs-keyword>return</span>
      }
      called = <span class=hljs-literal>true</span>
      reject(e)
    }
  } <span class=hljs-keyword>else</span> {
    resolve(x)
  }
}
</code></pre><h1 id=&#x5904;&#x7406;&#x53EF;&#x9009;&#x53C2;&#x6570;>&#x5904;&#x7406;&#x53EF;&#x9009;&#x53C2;&#x6570;</h1><p>PromiseA+&#x89C4;&#x8303;&#x89C4;&#x5B9A;&#xFF1A;onFulfilled&#x548C;onRejected&#x90FD;&#x662F;&#x53EF;&#x9009;&#x53C2;&#x6570;</p><ul><li><p>&#x5982;&#x679C;&#x6CA1;&#x4F20;&#xFF0C;&#x5219;&#x7ED3;&#x679C;&#x503C;&#x4F1A;&#x4E00;&#x76F4;&#x7A7F;&#x900F;&#xFF0C;&#x76F4;&#x5230;&#x9047;&#x5230;&#x63D0;&#x4F9B;&#x4E86;&#x53C2;&#x6570;&#x4E3A;&#x6B62;</p><pre><code class=lang-js><span class=hljs-keyword>const</span> promise = <span class=hljs-keyword>new</span> <span class=hljs-built_in>Promise</span>((resolve, reject) =&gt; {
  resolve(<span class=hljs-string>&apos;&#x6210;&#x529F;&#x4E86;&apos;</span>)
})

promise.then().then().then(value =&gt; {
  <span class=hljs-built_in>console</span>.log(value) <span class=hljs-comment>// &#x6210;&#x529F;&#x4E86;</span>
})
</code></pre><pre><code class=lang-js><span class=hljs-keyword>const</span> <span class=hljs-built_in>Promise</span> = <span class=hljs-built_in>require</span>(<span class=hljs-string>&apos;./promise&apos;</span>)

<span class=hljs-keyword>const</span> promise = <span class=hljs-keyword>new</span> <span class=hljs-built_in>Promise</span>((resolve, reject) =&gt; {
  reject(<span class=hljs-string>&apos;&#x5931;&#x8D25;&#x4E86;&apos;</span>)
})

promise.then().then().then(<span class=hljs-literal>null</span>, reason =&gt; {
  <span class=hljs-built_in>console</span>.log(reason) <span class=hljs-comment>// &#x5931;&#x8D25;&#x4E86;</span>
})
</code></pre></li><li>&#x5982;&#x679C;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x5219;&#x5FFD;&#x7565;</li></ul><pre><code class=lang-js>promise.then().then().then(value =&gt; {
  <span class=hljs-built_in>console</span>.log(value) <span class=hljs-comment>// &#x6210;&#x529F;&#x4E86;</span>
})
</code></pre><p>&#x8FD9;&#x4E2A;&#x6548;&#x679C;&#x8BE5;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x5462;&#xFF1F;&#x76EE;&#x524D;&#x6211;&#x4EEC;&#x7684;&#x4EE3;&#x7801;&#x662F;&#x62A5;&#x9519;&#x7684;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x9519;&#x8BEF;&#x88AB;&#x6355;&#x83B7;&#x4E86;&#x800C;&#x5DF2;&#xFF0C;&#x56E0;&#x4E3A;&#x7B2C;&#x4E00;&#x4E2A;then&#x4E2D;&#x90FD;&#x6CA1;&#x6709;&#x4F20;&#x5165;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#xFF0C;&#x800C;&#x4EE3;&#x7801;&#x4E2D;&#x6211;&#x4EEC;&#x786E;&#x8C03;&#x7528;&#x4E86;&#xFF0C;&#x90A3;&#x80AF;&#x5B9A;&#x662F;&#x62A5;&#x9519;&#x3002;</p><p>&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4F20;&#x5165;onFulfilled&#x53C2;&#x6570;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x4EE3;&#x7801;&#x82E5;&#x80FD;&#x9ED8;&#x8BA4;&#x5E72;&#x5982;&#x4E0B;&#x7684;&#x5DE5;&#x4F5C;&#xFF1A;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x51FD;&#x6570;&#x5C06;&#x7ED3;&#x679C;&#x503C;&#x8FD4;&#x56DE;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x5B9E;&#x73B0;&#x4E86;&#x8BE5;&#x529F;&#x80FD;&#xFF0C;&#x5C31;&#x597D;&#x6BD4;&#x5982;&#x4E0B;&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x5C31;&#x6CA1;&#x6709;&#x95EE;&#x9898;&#xFF1A;</p><pre><code class=lang-js>promise.then(value =&gt; value).then(value =&gt; value).then(value =&gt; {
  <span class=hljs-built_in>console</span>.log(value) <span class=hljs-comment>// &#x6210;&#x529F;&#x4E86;</span>
})
</code></pre><p>&#x6240;&#x4EE5;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#xFF1A;&#x5982;&#x679C;&#x6CA1;&#x4F20;&#x51FD;&#x6570;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5C31;&#x653E;&#x4E00;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x51FD;&#x6570;&#x8FDB;&#x53BB;&#xFF0C;&#x5E76;&#x5C06;&#x7ED3;&#x679C;&#x503C;&#x8FD4;&#x56DE;</p><pre><code class=lang-js>then (onFulfilled, onRejected) {
  onFulfilled = <span class=hljs-keyword>typeof</span> onFulfilled === <span class=hljs-string>&apos;function&apos;</span> ? onFulfilled : value =&gt; value
  ...
}
</code></pre><p>&#x63A5;&#x4E0B;&#x6765;&#x5B9E;&#x73B0;reject&#x7684;&#x60C5;&#x51B5;</p><pre><code class=lang-js>promise.then().then().then(<span class=hljs-literal>null</span>, reason =&gt; {
  <span class=hljs-built_in>console</span>.log(reason) <span class=hljs-comment>// &#x5931;&#x8D25;&#x4E86;</span>
})
</code></pre><p>&#x4E0A;&#x9762;&#x8FD9;&#x4E2A;&#x6548;&#x679C;&#x53C8;&#x8BE5;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x5462;&#xFF1F;&#x5C06;&#x4EE3;&#x7801;&#x6539;&#x5199;&#x4E3A;&#x5982;&#x4E0B;&#x5F62;&#x5F0F;&#xFF1A;</p><pre><code class=lang-js>promise.then(<span class=hljs-literal>null</span>, error =&gt; {
  <span class=hljs-keyword>throw</span> error
}).then(<span class=hljs-literal>null</span>, error =&gt; {
  <span class=hljs-keyword>throw</span> error
}).then(<span class=hljs-literal>null</span>, reason =&gt; {
  <span class=hljs-built_in>console</span>.log(reason)
})
</code></pre><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5199;&#x6210;&#x4E0A;&#x9762;&#x7684;&#x5F62;&#x5F0F;&#x5C31;&#x5B9E;&#x73B0;&#x4E86;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x539F;&#x7406;&#xFF0C;&#x6240;&#x4EE5;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4F20;&#x5165;onRejected&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x5C31;&#x653E;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x5E76;&#x4E14;&#x8BE5;&#x51FD;&#x6570;&#x629B;&#x51FA;&#x7ED3;&#x679C;&#x503C;</p><pre><code class=lang-js>then (onFulfilled, onRejected) {
  onRejected = <span class=hljs-keyword>typeof</span> onRejected === <span class=hljs-string>&apos;function&apos;</span> ? onRejected : reason =&gt; { <span class=hljs-keyword>throw</span> reason }
  ...
}
</code></pre><h1 id=&#x5904;&#x7406;resolve&#x4E2D;&#x5D4C;&#x5957;promise>&#x5904;&#x7406;resolve&#x4E2D;&#x5D4C;&#x5957;Promise</h1><pre><code class=lang-js><span class=hljs-keyword>const</span> <span class=hljs-built_in>Promise</span> = <span class=hljs-built_in>require</span>(<span class=hljs-string>&apos;./promise&apos;</span>)

<span class=hljs-keyword>const</span> promise = <span class=hljs-keyword>new</span> <span class=hljs-built_in>Promise</span>((resolve, reject) =&gt; {
  <span class=hljs-comment>// resolve&#x4E2D;&#x53C8;&#x6709;&#x4E00;&#x4E2A;Promise&#xFF0C;&#x6211;&#x4EEC;&#x6700;&#x7EC8;&#x62FF;&#x5230;&#x7684;&#x5E94;&#x8BE5;&#x662F;&apos;ok&apos;&#x624D;&#x5BF9;&#xFF0C;&#x800C;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x62FF;&#x5230;&#x7684;&#x662F;&#x6574;&#x4E2A;Promise&#x5B9E;&#x4F8B;</span>
  resolve(<span class=hljs-keyword>new</span> <span class=hljs-built_in>Promise</span>((resolve, reject) =&gt; {
    resolve(<span class=hljs-string>&apos;ok&apos;</span>)
  }))
})
</code></pre><pre><code class=lang-js><span class=hljs-class><span class=hljs-keyword>class</span> <span class=hljs-title>Promise</span> </span>{
  <span class=hljs-keyword>constructor</span> (executor) {
    ...
    const resolve = value =&gt; {
      <span class=hljs-comment>// &#x5224;&#x65AD;value&#x662F;&#x5426;&#x4E3A;Promise</span>
      <span class=hljs-keyword>if</span> (value <span class=hljs-keyword>instanceof</span> <span class=hljs-built_in>Promise</span>) {
        <span class=hljs-keyword>return</span> value.then(resolve, reject)
      }
      ...
    }
  }
}
</code></pre><p>&#x81F3;&#x6B64;Promise&#x7684;&#x6838;&#x5FC3;&#x529F;&#x80FD;&#x4EE5;&#x5B9E;&#x73B0;&#x5B8C;&#x6BD5;&#xFF0C;&#x5176;&#x5B83;api&#x7684;&#x5B9E;&#x73B0;&#x5C31;&#x76F8;&#x5BF9;&#x7B80;&#x5355;&#x4E86;&#xFF0C;&#x4E0B;&#x9762;&#x8D34;&#x51FA;&#x5230;&#x76EE;&#x524D;&#x4E3A;&#x6B62;&#x7684;&#x5B8C;&#x6574;&#x4EE3;&#x7801;&#xFF1A;</p><pre><code class=lang-js><span class=hljs-keyword>const</span> PENDING = <span class=hljs-string>&apos;PENDING&apos;</span>
<span class=hljs-keyword>const</span> FULFILLED = <span class=hljs-string>&apos;FULFILLED&apos;</span>
<span class=hljs-keyword>const</span> REJECTED = <span class=hljs-string>&apos;REJECTED&apos;</span>
<span class=hljs-keyword>const</span> resolvePromise = (promise2, x, resolve, reject) =&gt; {
  <span class=hljs-keyword>if</span> (x === promise2) { <span class=hljs-comment>// &#x8BF4;&#x660E;&#x6B7B;&#x5FAA;&#x73AF;&#x4E86;&#xFF0C;&#x76F4;&#x63A5;&#x62D2;&#x7EDD;&#x5373;&#x53EF;</span>
    <span class=hljs-keyword>return</span> reject(<span class=hljs-keyword>new</span> <span class=hljs-built_in>TypeError</span>(<span class=hljs-string>&apos;Chaining cycle detected for promise #&lt;Promise&gt;&lt;/Promise&gt;&apos;</span>))
  }

  <span class=hljs-comment>// &#x63A5;&#x4E0B;&#x6765; &#x8981;&#x5224;&#x65AD;x&#x7684;&#x7C7B;&#x578B;  &#x662F;&#x666E;&#x901A;&#x503C;&#x8FD8;&#x662F;Promise</span>

  <span class=hljs-keyword>let</span> called = <span class=hljs-literal>false</span>
  <span class=hljs-keyword>if</span> ((<span class=hljs-keyword>typeof</span> x === <span class=hljs-string>&apos;object&apos;</span> &amp;&amp; x !== <span class=hljs-literal>null</span>) || <span class=hljs-keyword>typeof</span> x === <span class=hljs-string>&apos;function&apos;</span>) {
    <span class=hljs-comment>// &#x5982;&#x4F55;&#x5224;&#x65AD;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x4E3A;Promise&#xFF0C;&#x6362;&#x8A00;&#x4E4B;&#x662F;&#x5426;&#x4E3A;thenable&#x5BF9;&#x8C61;&#xFF1F;&#x53EA;&#x9700;&#x5224;&#x65AD;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x62E5;&#x6709;then&#x65B9;&#x6CD5;&#x5373;&#x53EF;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;thenable&#x5BF9;&#x8C61;&#x7684;&#x5B9A;&#x4E49;</span>
    <span class=hljs-keyword>try</span> {
      <span class=hljs-keyword>const</span> then = x.then <span class=hljs-comment>// &#x83B7;&#x53D6;then&#x65B9;&#x6CD5;</span>
      <span class=hljs-keyword>if</span> (<span class=hljs-keyword>typeof</span> then === <span class=hljs-string>&apos;function&apos;</span>) { <span class=hljs-comment>// &#x786E;&#x4FDD;then&#x662F;&#x65B9;&#x6CD5;</span>
        then.call(x, y =&gt; {
          <span class=hljs-keyword>if</span> (called) {
            <span class=hljs-keyword>return</span>
          }
          called = <span class=hljs-literal>true</span>
          <span class=hljs-comment>// &#x9012;&#x5F52;&#x89E3;&#x6790;y&#xFF0C;&#x76F4;&#x5230;&#x4FDD;&#x8BC1;&#x5B83;&#x4E3A;&#x4E00;&#x4E2A;&#x666E;&#x901A;&#x503C;&#x4E3A;&#x6B62;</span>
          resolvePromise(promise2, y, resolve, reject)
        }, r =&gt; {
          <span class=hljs-keyword>if</span> (called) {
            <span class=hljs-keyword>return</span>
          }
          called = <span class=hljs-literal>true</span>
          reject(r)
        })
      } <span class=hljs-keyword>else</span> { <span class=hljs-comment>// then&#x4E0D;&#x662F;&#x65B9;&#x6CD5;&#xFF0C;&#x5219;&#x8BA4;&#x4E3A;x&#x662F;&#x4E00;&#x4E2A;&#x666E;&#x901A;&#x503C;&#xFF0C;&#x76F4;&#x63A5;resolve(x)</span>
        resolve(x)
      }
    } <span class=hljs-keyword>catch</span> (e) {
      <span class=hljs-keyword>if</span> (called) {
        <span class=hljs-keyword>return</span>
      }
      called = <span class=hljs-literal>true</span>
      reject(e)
    }
  } <span class=hljs-keyword>else</span> {
    <span class=hljs-comment>// x&#x662F;&#x666E;&#x901A;&#x503C;</span>
    resolve(x)
  }
}
<span class=hljs-class><span class=hljs-keyword>class</span> <span class=hljs-title>Promise</span> </span>{
  <span class=hljs-keyword>constructor</span> (executor) {
    <span class=hljs-keyword>this</span>.status = PENDING
    <span class=hljs-keyword>this</span>.value = <span class=hljs-literal>undefined</span>
    <span class=hljs-keyword>this</span>.reason = <span class=hljs-literal>undefined</span>

    <span class=hljs-keyword>this</span>.onFulfilledCallbacks = [] <span class=hljs-comment>// &#x5B58;&#x653E;&#x6210;&#x529F;&#x56DE;&#x8C03;&#x51FD;&#x6570;</span>
    <span class=hljs-keyword>this</span>.onRejectedCallbacks = [] <span class=hljs-comment>// &#x5B58;&#x653E;&#x5931;&#x8D25;&#x56DE;&#x8C03;&#x51FD;&#x6570;</span>
    <span class=hljs-keyword>const</span> resolve = value =&gt; {
      <span class=hljs-keyword>if</span> (value <span class=hljs-keyword>instanceof</span> <span class=hljs-built_in>Promise</span>) {
        <span class=hljs-keyword>return</span> value.then(resolve, reject)
      }
      <span class=hljs-keyword>if</span> (<span class=hljs-keyword>this</span>.status === PENDING) {
        <span class=hljs-keyword>this</span>.status = FULFILLED
        <span class=hljs-keyword>this</span>.value = value
        <span class=hljs-keyword>this</span>.onFulfilledCallbacks.forEach(fn =&gt; fn())
      }
    }
    <span class=hljs-keyword>const</span> reject = reason =&gt; {
      <span class=hljs-keyword>if</span> (<span class=hljs-keyword>this</span>.status === PENDING) {
        <span class=hljs-keyword>this</span>.status = REJECTED
        <span class=hljs-keyword>this</span>.reason = reason
        <span class=hljs-keyword>this</span>.onRejectedCallbacks.forEach(fn =&gt; fn())
      }
    }

    <span class=hljs-keyword>try</span> {
      executor(resolve, reject)
    } <span class=hljs-keyword>catch</span> (e) {
      reject(e)
    }
  }

  then (onFulfilled, onRejected) {
    onFulfilled = <span class=hljs-keyword>typeof</span> onFulfilled === <span class=hljs-string>&apos;function&apos;</span> ? onFulfilled : value =&gt; value
    onRejected = <span class=hljs-keyword>typeof</span> onRejected === <span class=hljs-string>&apos;function&apos;</span> ? onRejected : reason =&gt; { <span class=hljs-keyword>throw</span> reason }
    <span class=hljs-keyword>const</span> promise2 = <span class=hljs-keyword>new</span> <span class=hljs-built_in>Promise</span>((resolve, reject) =&gt; {
      <span class=hljs-keyword>if</span> (<span class=hljs-keyword>this</span>.status === FULFILLED) {
        setTimeout(() =&gt; {
          <span class=hljs-keyword>try</span> {
            <span class=hljs-keyword>const</span> x = onFulfilled(<span class=hljs-keyword>this</span>.value)
            resolvePromise(promise2, x, resolve, reject)
          } <span class=hljs-keyword>catch</span> (e) {
            reject(e)
          }
        })
      }
      <span class=hljs-keyword>if</span> (<span class=hljs-keyword>this</span>.status === REJECTED) {
        setTimeout(() =&gt; {
          <span class=hljs-keyword>try</span> {
            <span class=hljs-keyword>const</span> x = onRejected(<span class=hljs-keyword>this</span>.reason)
            resolvePromise(promise2, x, resolve, reject)
          } <span class=hljs-keyword>catch</span> (e) {
            reject(e)
          }
        })
      }

      <span class=hljs-comment>// &#x5982;&#x679C;&#x662F;pending&#x72B6;&#x6001;&#xFF0C;&#x5219;&#x8BF4;&#x660E;&#x5B58;&#x5728;&#x5F02;&#x6B65;&#x4EE3;&#x7801;&#xFF0C;&#x9700;&#x8981;&#x5148;&#x5C06;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x5B58;&#x653E;&#x8D77;&#x6765;&#xFF0C;&#x7B49;&#x5230;resolve&#x65B9;&#x6CD5;&#x6216;reject&#x65B9;&#x6CD5;&#x88AB;&#x8C03;&#x7528;&#x65F6;&#xFF0C;&#x518D;&#x4F9D;&#x6B21;&#x8C03;&#x7528;</span>
      <span class=hljs-keyword>if</span> (<span class=hljs-keyword>this</span>.status === PENDING) {
        <span class=hljs-keyword>this</span>.onFulfilledCallbacks.push(() =&gt; {
          setTimeout(() =&gt; {
            <span class=hljs-keyword>try</span> {
              <span class=hljs-keyword>const</span> x = onFulfilled(<span class=hljs-keyword>this</span>.value)
              resolvePromise(promise2, x, resolve, reject)
            } <span class=hljs-keyword>catch</span> (e) {
              reject(e)
            }
          })
        })
        <span class=hljs-keyword>this</span>.onRejectedCallbacks.push(() =&gt; {
          setTimeout(() =&gt; {
            <span class=hljs-keyword>try</span> {
              <span class=hljs-keyword>const</span> x = onRejected(<span class=hljs-keyword>this</span>.reason)
              resolvePromise(promise2, x, resolve, reject)
            } <span class=hljs-keyword>catch</span> (e) {
              reject(e)
            }
          })
        })
      }
    })
    <span class=hljs-keyword>return</span> promise2
  }
}

<span class=hljs-built_in>module</span>.exports = <span class=hljs-built_in>Promise</span>
</code></pre></section></div><div class=search-results><div class=has-results><h1 class=search-results-title><span class=search-results-count></span>results matching "<span class=search-query></span>"</h1><ul class=search-results-list></ul></div><div class=no-results><h1 class=search-results-title>No results matching "<span class=search-query></span>"</h1></div></div></div></div></div></div><a href=链式调用.html class="navigation navigation-prev" aria-label="Previous page: 3.4 链式调用"><i class="fa fa-angle-left"></i></a><a href=其它功能的实现.html class="navigation navigation-next" aria-label="Next page: 3.5 其它功能的实现"><i class="fa fa-angle-right"></i></a></div><script>var gitbook=gitbook||[];gitbook.push(function(){gitbook.page.hasChanged({page:{title:"3.5 处理多次调用及可选参数",level:"1.4.5",depth:2,next:{title:"3.5 其它功能的实现",level:"1.4.6",depth:2,path:"chapter3/其它功能的实现.md",ref:"chapter3/其它功能的实现.md",articles:[]},previous:{title:"3.4 链式调用",level:"1.4.4",depth:2,path:"chapter3/链式调用.md",ref:"chapter3/链式调用.md",articles:[]},dir:"ltr"},config:{gitbook:"*",theme:"default",variables:{},plugins:[],pluginsConfig:{highlight:{},search:{},lunr:{maxIndexSize:1e6,ignoreSpecialCharacters:!1},sharing:{facebook:!0,twitter:!0,google:!1,weibo:!1,instapaper:!1,vk:!1,all:["facebook","google","twitter","weibo","instapaper"]},fontsettings:{theme:"white",family:"sans",size:2},"theme-default":{styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"},showLevel:!1}},structure:{langs:"LANGS.md",readme:"README.md",glossary:"GLOSSARY.md",summary:"SUMMARY.md"},pdf:{pageNumbers:!0,fontSize:12,fontFamily:"Arial",paperSize:"a4",chapterMark:"pagebreak",pageBreaksBefore:"/",margin:{right:62,left:62,top:56,bottom:56}},styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"}},file:{path:"chapter3/处理多次调用及可选参数.md",mtime:"2020-08-20T08:14:09.231Z",type:"markdown"},gitbook:{version:"3.2.3",time:"2020-08-20T08:23:33.468Z"},basePath:"..",book:{language:""}})})</script></div><script src=../gitbook/gitbook.js></script><script src=../gitbook/theme.js></script><script src=../gitbook/gitbook-plugin-search/search-engine.js></script><script src=../gitbook/gitbook-plugin-search/search.js></script><script src=../gitbook/gitbook-plugin-lunr/lunr.min.js></script><script src=../gitbook/gitbook-plugin-lunr/search-lunr.js></script><script src=../gitbook/gitbook-plugin-sharing/buttons.js></script><script src=../gitbook/gitbook-plugin-fontsettings/fontsettings.js></script></body></html>